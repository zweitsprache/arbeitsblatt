# Internationalization (i18n)

This project uses [next-intl](https://next-intl.dev/) for translations and
[i18nexus](https://i18nexus.com/) as the cloud-based translation management
system.

## Architecture

```
i18nexus (cloud)  ──pull──▶  src/messages/{locale}.json  ──load──▶  next-intl
                                                                      │
                                            BLOCK_LIBRARY fallbacks ──┘
                                            (code-translations.ts)
```

**i18nexus is the single source of truth.** The JSON files in `src/messages/`
are generated artifacts — they are overwritten every time `i18nexus pull` or
`i18nexus listen` runs. Never treat them as manually-editable source files.

### Supported locales

| Locale | File | Default |
|--------|------|---------|
| `de` (German) | `src/messages/de.json` | ✅ |
| `en` (English) | `src/messages/en.json` | |

Configured in `src/i18n/routing.ts`.

### Translation flow

1. Translations are managed in the **i18nexus dashboard**
2. `i18nexus pull` writes `de.json` and `en.json` (full replace, not merge)
3. `next-intl` loads the JSON at request time (`src/i18n/request.ts`)
4. `BLOCK_LIBRARY` fallback labels are merged for blocks not yet in i18nexus
5. Components consume translations via `useTranslations("namespace")`

## How to add new translations

### Option A: Via i18nexus dashboard (preferred)

1. Add the key in the i18nexus web UI
2. Add translations for both `de` and `en`
3. Run `npm run i18n:pull` to download updated JSON files
4. Commit the updated JSON files

### Option B: Via JSON files (for bulk changes)

1. Edit `src/messages/de.json` (base language) with your new keys
2. Run `npm run i18n:import` to upload base strings to i18nexus
3. Add English translations in the i18nexus dashboard
4. Run `npm run i18n:pull` to download both locales
5. Run `npm run i18n:validate` to verify parity
6. Commit the JSON files

> **Note:** The i18nexus CLI `import` only supports the base language (German).
> English translations must be added via the i18nexus web dashboard.

### Adding translations for a new block type

When you add a new block to `BLOCK_LIBRARY` in `src/types/worksheet.ts`:

1. Set `labelKey` and `descriptionKey` (these reference the `blocks` namespace)
2. Add `translations` with `de` values (these serve as fallbacks)
3. Add the keys to i18nexus in the `blocks` namespace
4. Run `npm run i18n:pull`

The BLOCK_LIBRARY `translations` object provides emergency fallback labels so
the UI never shows raw keys, even before the translations are added to i18nexus.

## NPM scripts

| Script | Purpose |
|--------|---------|
| `npm run dev` | Starts Next.js + live i18nexus sync (`listen`) |
| `npm run i18n:pull` | Download latest translations from i18nexus |
| `npm run i18n:validate` | Check that `de.json` and `en.json` are in sync |
| `npm run i18n:import` | Upload `de.json` (base language) to i18nexus |
| `npm run i18n:sync` | Import → pull → validate (full round-trip) |

## Build-time validation

The `build` script runs `validate-translations.mjs` after pulling from
i18nexus. If any namespace or key is missing in either locale, **the build
fails**. This prevents deploying with broken translations.

```
prisma generate → i18nexus pull → validate-translations → next build
```

## Environment variables

| Variable | Required for |
|----------|-------------|
| `I18NEXUS_API_KEY` | `i18n:pull`, `i18n:import`, `build` |
| `I18NEXUS_PERSONAL_ACCESS_TOKEN` | `i18n:import` |

These are set in `.env.local` (not committed to git).

## Common issues

### "Translations missing after deploy"

This happened historically because:
- Only `de.json` was imported to i18nexus, so English-only keys were lost
- Translations added in code but not in i18nexus were wiped on `pull`
- `i18nexus pull` does a **full file replacement**, not a merge

**Now fixed by:**
- All base strings are imported to i18nexus (`i18n:import`)
- All translations live in i18nexus (no more code-only translations)
- Build-time validation catches missing keys before deploy
- BLOCK_LIBRARY provides fallback labels as a safety net

### "I added a key but it's not showing up"

1. Did you add it to **both** `de` and `en` in i18nexus?
2. Did you run `npm run i18n:pull`?
3. Run `npm run i18n:validate` to check for missing keys

## File reference

| File | Purpose |
|------|---------|
| `src/messages/de.json` | German translations (auto-generated by i18nexus) |
| `src/messages/en.json` | English translations (auto-generated by i18nexus) |
| `src/i18n/code-translations.ts` | BLOCK_LIBRARY fallback labels only |
| `src/i18n/request.ts` | Server-side message loading + merge |
| `src/i18n/routing.ts` | Locale list + default locale |
| `src/i18n/navigation.ts` | Locale-aware Link, redirect, etc. |
| `src/proxy.ts` | Middleware for locale detection/routing |
| `scripts/validate-translations.mjs` | Build-time parity checker |
| `scripts/migrate-translations.mjs` | One-time migration (already run) |
